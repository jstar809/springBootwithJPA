<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layout/basic.html}">
<head>
<meta charset="UTF-8">
<title>Board Modify</title>
</head>

<div layout:fragment="content">
	<div class="row mt-3">
		<div class='col'>
			<div class="card">
				<div class="card-header">
					Board Modify
				</div>
				<div class="card-body">
					<form th:action="@{/board/modify(bno=${dto.bno})}" id ='fr1'>
						<div class="input-group mb-3">
							<span class="input-group-text">Bno</span>
							<input type="text" class="form-control" th:value="${dto.bno}" th:name="bno" readonly="readonly">
						</div>
						<div class="input-group mb-3">
							<span class="input-group-text">title</span>
							<input type="text" class="form-control" th:value="${dto.title}" name="title" >
						</div>
						<div class="input-group mb-3">
							<span class="input-group-text">content</span>
							<textarea  class="form-control col-sm-5" rows="5"  name="content">[[${dto.content}]]</textarea>
						</div>
						<div class="input-group mb-3">
							<span class="input-group-text">Writer</span>
							<input type="text" class="form-control" th:value="${dto.writer}" name="writer" readonly="readonly">
						</div>
						<div class="input-group mb-3">
    						<span class="input-group-text">Images</span>
    						<div class="float-end uploadHidden">
        						<button type="button" class="btn btn-primary uploadFileBtn">ADD Files</button>
						    </div>
						</div>
						<div class="input-group mb-3">
							<span class="input-group-text">regDate</span>
							<input type="text" class="form-control" th:value="${#temporals.format( dto.regDate , 'yyyy-MM-dd HH:mm:ss' )}" readonly="readonly">
						</div>
						<div class="input-group mb-3">
							<span class="input-group-text">modDate</span>
							<input type="text" class="form-control" th:value="${#temporals.format( dto.modDate , 'yyyy-MM-dd HH:mm:ss' )}" readonly="readonly">
						</div>
					</form>					
					
					<div class="my-4">
						<div class="float-end" th:with="link=${pageRequsetDTO.link}">
							<button type="button" class="btn btn-primary" id="listBtn"> List</button>
							<button type="button" class="btn btn-secondary" id="modBtn"> modify</button>
							<button type="button" class="btn btn-danger" id="delBtn"> delete</button>
						</div>
					</div>
					
				</div>
			</div>
		</div>
	</div>
	
	
	<div class="row mt-3">
	  	<div class="col">
	    	<div class="container-fluid d-flex uploadResult" style="flex-wrap: wrap;">
	    		<th:block th:each="fileName : ${dto.fileNames}">
	    			<div class="card col-4" th:with="arr = ${fileName.split('_')}">
	    				<div class="card-header d-flex justfy-content-center">
	    					[[${arr[1]}]]
	    					<button class="btn-sm btn-danger" th:onclick="removeFile([[${arr[0]}]] ,[[${arr[1]}]] ,this)">x</button>
	    				</div>
	    				<div class="card-body">
							<img  th:src="|@{/view/}${fileName}|" th:data-src="${fileName}">	    				
	    				</div>
	    			</div>
	    		</th:block>
			</div>
  		</div>
	</div>
	
	<!-- 첨부파일 추가를 위한 모달창 -->
	<div class="modal uploadModal" tabindex="-1">
  		<div class="modal-dialog">
    		<div class="modal-content">
      			<div class="modal-header">
        			<h5 class="modal-title">Upload File</h5>
			        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      			</div>
      			<div class="modal-body">
        			<div class="input-group mb-3">
          				<input type="file" name="files" class="form-control" multiple>
			        </div>
      			</div>
      			<div class="modal-footer">
        			<button type="button" class="btn btn-primary uploadBtn">Upload</button>
			        <button type="button" class="btn btn-outline-dark closeUploadBtn">Close</button>
      			</div>
    		</div>
  		</div>
	</div><!-- register modal -->
	
		
	
</div>

<th:block layout:fragment="importScript">
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script th:src="@{/js/upload.js}"></script>	
</th:block>


<script layout:fragment="script" th:inline="javascript">
	const errors = [[${errors}]];
	
	let errorMsg="";
	
	if(errors){
		for(let error of errors ){
			errorMsg += error.field + " 에서 " +error.code +"\n"
		}
		history.replaceState({}, null, null);
		alert(errorMsg);
	}
	
	const link = [[${pageRequsetDTO.link}]];
	const formObj = document.querySelector('#fr1');
	
	/* document.querySelector('#modBtn').addEventListener("click" , (e)=>{
		e.preventDefault();
		e.stopPropagation();
		
		formObj.action = `/board/modify?${link}`;
		formObj.method = "post";
		formObj.submit();
	}); */
	
	
	document.querySelector('#delBtn').addEventListener("click" , (e)=>{
		e.preventDefault();
		e.stopPropagation();
		
		// 화면에 보이는 파일들을 form 태그에 추가
		appendFileData()
		// 화면에서 안 보이도록 처리된 파일들을 form 태그에 추가
		appendNotShownData()
		
		formObj.action = `/board/remove`;
		formObj.method = "post";
		formObj.submit();
	});
	
	document.querySelector('#listBtn').addEventListener("click" , (e)=>{
		e.preventDefault();
		e.stopPropagation();
		
		formObj.reset();
		location.href=`/board/list?${link}`
	});
	
	const removeFileList = [];
	
	function removeFile(uuid, fileName , obj){
		if(!confirm("are you delete")){
			return
		}
		
		removeFileList.push({uuid, fileName})
		
		const targetDiv = obj.closest(".card");
		targetDiv.remove();
		
	}
	
	
	//업로드 모달
	const uploadModal = new bootstrap.Modal(document.querySelector(".uploadModal"))

	document.querySelector(".uploadFileBtn").addEventListener("click", function(e){
	    e.stopPropagation()
	    e.preventDefault()
	    uploadModal.show()
	}, false)

	document.querySelector(".uploadBtn").addEventListener("click", function(e){
	    const formObj = new FormData();
	    const fileInput = document.querySelector("input[name='files']")

	    console.log(fileInput.files)

	    const files = fileInput.files

	    for (let i = 0; i < files.length; i++) {
	        formObj.append("files", files[i])
	    }

	    upLoadToServer(formObj).then(result => {
	        console.log(result)
	        //console.log(result)
	        for (const uploadResult of result) {
	        	console.log("1      "+uploadResult)
	            showUploadFile(uploadResult)
	        }
	        uploadModal.hide()
	    }).catch(e => {
	        uploadModal.hide()
	    })

    },false)

    const uploadResult = document.querySelector(".uploadResult")

    function showUploadFile({uuid, fileName, link}){
        const str = `<div class="card col-4">
            <div class="card-header d-flex justify-content-center">
                ${fileName}
                <button class="btn-sm btn-danger" onclick="javascript:removeFile('${uuid}', '${fileName}', this)">x</button>
            </div>
            <div class="card-body">
                <img src="/view/${link}" data-src="${uuid+"_"+fileName}">
            </div>
        </div><!-- card -->`

        uploadResult.innerHTML += str
    }
	
	document.querySelector("#modBtn").addEventListener("click", function(e){
	    e.preventDefault()
	    e.stopPropagation()

	    formObj.action = `/board/modify?${link}`

	    //첨부파일을 <input type='hidden..>으로 추가
	    appendFileData()

	    //삭제대상 파일들의 삭제
	    callRemoveFiles()

	    formObj.method = 'post'
	    formObj.submit()
	})

	
	
	function appendFileData(){
	    const target = document.querySelector(".uploadHidden")
	    const uploadFiles = uploadResult.querySelectorAll("img")

	    let str = ''

	    for (let i = 0; i < uploadFiles.length ; i++) {
	        const uploadFile = uploadFiles[i]
	        const imgLink = uploadFile.getAttribute("data-src")

	        str += `<input type='hidden' name='fileNames' value='${imgLink}'>`
	    }

	    target.innerHTML = str;
	}

	function callRemoveFiles(){
	    removeFileList.forEach(({uuid,fileName}) => {
	    	removeFileToServr({uuid, fileName})
	    })
	}
	
	function appendNotShownData(){
	    if(removeFileList.length == 0){
	        return
	    }
	    
	    const target = document.querySelector(".uploadHidden")
	    let str = ''

	    for (let i = 0; i < removeFileList.length ; i++) {
	        const {uuid, fileName} = removeFileList[i];

	        str += `<input type='hidden' name='fileNames' value='${uuid}_${fileName}'>`
	    }
	    target.innerHTML += str;

	}
	
</script>

</html>